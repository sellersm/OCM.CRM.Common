<QueryViewSpec
	xmlns="bb_appfx_queryview"
	xmlns:common="bb_appfx_commontypes" 
	ID="D180114E-16BB-4387-9BC1-FF0AA685433F"
	Name="Christmas Ornament Recipient Query"
	Description="Sponsors who received an ornaments in 2013 - No Gifting Sponsors"
	Author="Cary Mayeda"
	IsRoot="true"
	PrimaryKeyField="CONSTITUENTID"
	RecordType="Constituent"
	common:SecurityUIFolder="Constituent"
	>

	<!-- define the view used to return data for the query -->
	<ViewImplementation ViewName="USR_V_QUERY_CHRISTMASORNAMENTS_RECIPIENT">
		<ViewSQL>
			<![CDATA[
			
with Received2013Ornament
as
(
select distinct 
	c.ID, C.NAME
from 
	dbo.CONSTITUENT c
	join dbo.CONSTITUENTAPPEAL ca on ca.CONSTITUENTID = c.ID
	join dbo.APPEAL a on ca.APPEALID = a.ID
where 
	a.NAME = '10554 - Christmas Ornaments'
)
select 
	s.CONSTITUENTID,
	so.ID as CHILDID,
	project.LOOKUPID as PROJECTLOOKUPID,
	so.LOOKUPID as CHILDLOOKUPID,
	so_child.FIRSTNAME as CHILDFIRSTNAME,
	so_child.NAME as CHILDNAME
from 
	dbo.SPONSORSHIP s
	join dbo.SPONSORSHIPOPPORTUNITY so ON so.ID = s.SPONSORSHIPOPPORTUNITYID
	join dbo.SPONSORSHIPOPPORTUNITYCHILD so_child on so_child.ID = s.SPONSORSHIPOPPORTUNITYID
	join dbo.SPONSORSHIPLOCATION slocation on so.SPONSORSHIPLOCATIONID = slocation.ID 						
	join dbo.CONSTITUENT project on project.ID = slocation.FIELDOFFICEID
	
where 
	s.STATUSCODE = 1
and	s.STARTDATE > '11/20/13'
and not exists (select s2.ID from dbo.SPONSORSHIP s2 where s2.SPONSORSHIPOPPORTUNITYID = s.SPONSORSHIPOPPORTUNITYID and s2.CONSTITUENTID = s.CONSTITUENTID and s2.STARTDATE <= '11/20/13')
and	exists (select ro.ID from Received2013Ornament ro where ro.ID = s.CONSTITUENTID)

			]]>
		</ViewSQL>
	</ViewImplementation>

	<!-- describe each field in the view output -->
	<Output>
		<OutputFields>
			<OutputField Caption="Sponsor System record ID" Category="System Fields" Name="CONSTITUENTID" />
			<OutputField Name="CHILDID" Caption="Child System record ID" Category="System Fields" DataType="Guid" />
			<OutputField Name="PROJECTLOOKUPID" Caption="Project Lookup ID" DataType="String" />
			<OutputField Name="CHILDFIRSTNAME" Caption="Child First Name" DataType="String" />
			<OutputField Name="CHILDNAME" Caption="Child Full Name" DataType="String" />
		</OutputFields>
	</Output>

	<RelationshipOperations>
		<AddRelatedView RelatedView="V_QUERY_SPONSORSHIPOPPORTUNITY" Field="CHILDID" RelatedField="ID" Cardinality="OneToOne" PathAlias="Sponsored Child" />
		<AddRelatedView RelatedView="V_QUERY_CONSTITUENT" Field="CONSTITUENTID" RelatedField="ID" Cardinality="OneToOne"  PathAlias="Sponsor"/>
	</RelationshipOperations>

</QueryViewSpec>

