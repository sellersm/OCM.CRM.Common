<SQLFunctionSpec
	xmlns="bb_appfx_sqlfunction"
	xmlns:c="bb_appfx_commontypes" 
	ID="fb528d47-8e83-42c2-99a0-6cac11ee1fcc"
	Name="USR_UFN_GET_DECRYPTED_COLUMNVALUE"
	Description="Gets the decrypted value of a column."
	Author="Mark Sellers"
	DBFunctionName="USR_UFN_GET_DECRYPTED_COLUMNVALUE"
  GrantServiceRolePermission="true"
	>

	<CreateFunctionSQL>
		<![CDATA[
  CREATE FUNCTION dbo.USR_UFN_GET_DECRYPTED_COLUMNVALUE
  (
	  -- Add the parameters for the function here
	  @COLUMNVALUE nvarchar(max)
  )
  RETURNS nvarchar(max)
  AS
  BEGIN
	  -- Declare the return variable here
	  declare @decryptedValue nvarchar(max)
    EXEC dbo.USP_GET_KEY_ACCESS;
	  --open symmetric key sym_BBInfinity decryption by asymmetric key asym_BBInfinity;

	  -- populate the return value by doing the decryption:
	  set @decryptedValue = convert(nvarchar, decryptbykey(@COLUMNVALUE));
	
	  -- close up the key used to decrypt:
	  --CLOSE SYMMETRIC KEY sym_bbinfinity;
    EXEC dbo.CLOSE_KEY_ACCESS;

	  -- Return the result of the function
	  RETURN @decryptedValue

  END

		]]>
	</CreateFunctionSQL>

</SQLFunctionSpec>
