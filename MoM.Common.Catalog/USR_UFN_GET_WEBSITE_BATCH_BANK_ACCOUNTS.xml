<SQLFunctionSpec
	xmlns="bb_appfx_sqlfunction"
	xmlns:c="bb_appfx_commontypes" 
	ID="a097b7ca-6564-45ca-ad18-2e447389c3b8"
	Name="USR_UFN_GET_WEBSITE_BATCH_BANK_ACCOUNTS"
	Description="Gets website batch bank accounts."
	Author="Mark Sellers"
	DBFunctionName="USR_UFN_GET_WEBSITE_BATCH_BANK_ACCOUNTS"
  GrantServiceRolePermission="true"
	>

	<CreateFunctionSQL>
		<![CDATA[
create function dbo.USR_UFN_GET_WEBSITE_BATCH_BANK_ACCOUNTS()
returns @accountsTable table (
    ID uniqueidentifier,
    ACCOUNTNUMBER nvarchar(50),
    ROUTINGNUMBER nvarchar(50), 
    ACCOUNTNAME nvarchar(50),  
    FIRSTNAME nvarchar(50), 
    KEYNAME nvarchar(50), 
    BATCHNUMBER nvarchar(50), 
    LOOKUPID nvarchar(50), 
    DATE datetime)
as 
begin
  --EXEC dbo.Usp_get_key_access;
  insert into @accountsTable  
  select 
      --convert(nvarchar, decryptbykey(brca.ACCOUNTNUMBER)) as ACCOUNTNUMBER, 
      brca.ID,
      dbo.USR_UFN_GET_DECRYPTED_COLUMNVALUE(brca.ACCOUNTNUMBER) as ACCOUNTNUMBER, 
      fi.ROUTINGNUMBER, 
      brca.ACCOUNTNAME, 
      brc.FIRSTNAME, 
      brc.KEYNAME, 
      b.BATCHNUMBER, 
      c.LOOKUPID, 
      br.DATE
      from BATCHREVENUECONSTITUENTACCOUNT brca
      left join FINANCIALINSTITUTION fi on fi.id = brca.FINANCIALINSTITUTIONID
      left join BATCH b on b.id = brca.BATCHID
      left join BATCHREVENUE br on br.CONSTITUENTID = brca.CONSTITUENTID
      left join BATCHREVENUECONSTITUENT brc on brca.CONSTITUENTID = brc.ID
      left join CONSTITUENT c on c.id = brc.EXISTINGCONSTITUENTID
    
  --CLOSE SYMMETRIC KEY sym_bbinfinity  
  return
	
end
		]]>
	</CreateFunctionSQL>

</SQLFunctionSpec>
